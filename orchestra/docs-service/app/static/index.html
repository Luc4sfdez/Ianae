<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IANAE - Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --surface2: #1c2129; --border: #30363d;
    --text: #c9d1d9; --text-dim: #8b949e; --text-bright: #f0f6fc;
    --accent: #58a6ff; --green: #3fb950; --red: #f85149;
    --orange: #d29922; --purple: #bc8cff; --pink: #f778ba;
    --yellow: #e3b341;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, 'Segoe UI', monospace; background: var(--bg); color: var(--text); }

  /* Layout */
  .app { display: grid; grid-template-columns: 200px 1fr; grid-template-rows: auto auto 1fr; height: 100vh; }
  header { grid-column: 1 / -1; background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; gap: 16px; }
  header h1 { font-size: 16px; color: var(--accent); font-weight: 600; }
  header .subtitle { font-size: 12px; color: var(--text-dim); }

  /* Dashboard cards */
  .dashboard { grid-column: 1 / -1; display: flex; gap: 12px; padding: 12px 20px; background: var(--surface2); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; min-width: 140px; flex: 1; }
  .card .card-label { font-size: 10px; text-transform: uppercase; color: var(--text-dim); letter-spacing: 0.5px; margin-bottom: 4px; }
  .card .card-value { font-size: 22px; font-weight: 700; color: var(--text-bright); }
  .card .card-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .card.green .card-value { color: var(--green); }
  .card.red .card-value { color: var(--red); }
  .card.orange .card-value { color: var(--orange); }
  .card.purple .card-value { color: var(--purple); }
  .card.accent .card-value { color: var(--accent); }

  /* Sidebar */
  .sidebar { background: var(--surface); border-right: 1px solid var(--border); overflow-y: auto; padding: 8px 0; }
  .sidebar h3 { font-size: 10px; text-transform: uppercase; color: var(--text-dim); padding: 12px 12px 4px; letter-spacing: 0.5px; }
  .nav-btn { display: flex; align-items: center; gap: 8px; width: 100%; padding: 7px 12px; border: none; background: none; color: var(--text); cursor: pointer; font-size: 12px; text-align: left; }
  .nav-btn:hover { background: rgba(88,166,255,0.1); }
  .nav-btn.active { background: rgba(88,166,255,0.15); color: var(--accent); border-left: 2px solid var(--accent); }
  .nav-btn .icon { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .nav-btn .badge { margin-left: auto; background: var(--border); color: var(--text-dim); font-size: 10px; padding: 1px 5px; border-radius: 8px; }

  /* Main */
  .main { overflow-y: auto; padding: 16px 20px; }
  .toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .toolbar h2 { font-size: 14px; color: var(--text-bright); }
  .toolbar .info { font-size: 11px; color: var(--text-dim); }
  .toolbar .auto-ref { font-size: 11px; color: var(--text-dim); margin-left: auto; display: flex; align-items: center; gap: 4px; }
  .toolbar .auto-ref input { accent-color: var(--accent); }

  /* Tabs */
  .tabs { display: flex; gap: 2px; background: var(--surface); border-radius: 6px; padding: 2px; border: 1px solid var(--border); }
  .tabs button { padding: 4px 10px; border: none; background: none; color: var(--text-dim); cursor: pointer; border-radius: 4px; font-size: 12px; }
  .tabs button.active { background: var(--accent); color: var(--bg); }

  /* Thread */
  .thread { margin-bottom: 16px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .thread-hdr { background: var(--surface); padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; }
  .thread-hdr:hover { background: rgba(88,166,255,0.05); }
  .thread-hdr .t-title { font-size: 13px; color: var(--text-bright); font-weight: 500; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .thread-hdr .t-meta { font-size: 11px; color: var(--text-dim); }
  .thread-hdr .t-count { font-size: 10px; background: var(--border); padding: 1px 5px; border-radius: 8px; color: var(--text-dim); }
  .thread-msgs { display: none; }
  .thread.open .thread-msgs { display: block; }

  /* Message */
  .msg { padding: 10px 12px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
  .msg:hover { background: rgba(255,255,255,0.02); }
  .msg-av { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; flex-shrink: 0; color: var(--bg); }
  .msg-av.daemon { background: var(--purple); }
  .msg-av.worker-core { background: var(--green); }
  .msg-av.worker-nlp { background: var(--accent); }
  .msg-av.worker-infra { background: var(--orange); }
  .msg-av.worker-ui { background: var(--pink); }
  .msg-body { flex: 1; min-width: 0; }
  .msg-top { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
  .msg-author { font-size: 11px; font-weight: 600; color: var(--text-bright); }
  .msg-time { font-size: 10px; color: var(--text-dim); }
  .msg-title { font-size: 12px; color: var(--text); margin-bottom: 3px; }
  .msg-content { font-size: 11px; color: var(--text-dim); line-height: 1.4; max-height: 60px; overflow: hidden; white-space: pre-wrap; word-break: break-word; }
  .msg-content.expanded { max-height: none; }
  .msg-expand { font-size: 10px; color: var(--accent); cursor: pointer; margin-top: 3px; border: none; background: none; padding: 0; }
  .msg-tags { display: flex; gap: 3px; margin-top: 4px; flex-wrap: wrap; }
  .msg-tag { font-size: 9px; padding: 1px 5px; border-radius: 3px; background: rgba(88,166,255,0.1); color: var(--accent); }
  .msg-cost { font-size: 10px; color: var(--yellow); margin-top: 3px; }

  /* Status badge */
  .st { font-size: 10px; padding: 1px 6px; border-radius: 4px; font-weight: 500; white-space: nowrap; }
  .st.pending { background: rgba(210,153,34,0.2); color: var(--orange); }
  .st.in_progress { background: rgba(88,166,255,0.2); color: var(--accent); }
  .st.completed { background: rgba(63,185,80,0.2); color: var(--green); }
  .st.blocked { background: rgba(248,81,73,0.2); color: var(--red); }
  .st.done { background: rgba(63,185,80,0.2); color: var(--green); }

  /* Timeline */
  .tl-msg { padding: 6px 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: flex-start; }
  .tl-msg:hover { background: rgba(255,255,255,0.02); }
  .tl-msg .tl-time { font-size: 10px; color: var(--text-dim); min-width: 50px; flex-shrink: 0; padding-top: 2px; }
  .tl-msg .tl-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
  .tl-msg .tl-body { flex: 1; }
  .tl-msg .tl-title { font-size: 12px; color: var(--text); }
  .tl-msg .tl-sub { font-size: 10px; color: var(--text-dim); }

  /* Costs table */
  .cost-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .cost-table th { text-align: left; padding: 6px 10px; background: var(--surface); color: var(--text-dim); font-size: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border); position: sticky; top: 0; }
  .cost-table td { padding: 6px 10px; border-bottom: 1px solid var(--border); }
  .cost-table tr:hover { background: rgba(255,255,255,0.02); }
  .cost-table .cost-val { color: var(--yellow); font-weight: 600; }
  .cost-table .success-cell { color: var(--green); }
  .cost-table .fail-cell { color: var(--red); }

  /* Code section */
  .file-card { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; margin-bottom: 8px; }
  .file-card .file-path { font-size: 13px; color: var(--accent); font-weight: 500; }
  .file-card .file-meta { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .file-card.success { border-left: 3px solid var(--green); }
  .file-card.failed { border-left: 3px solid var(--red); }

  /* Provider badges */
  .prov { font-size: 10px; padding: 1px 6px; border-radius: 3px; font-weight: 500; }
  .prov.deepseek { background: rgba(63,185,80,0.15); color: var(--green); }
  .prov.anthropic { background: rgba(188,140,255,0.15); color: var(--purple); }
  .prov.qwen { background: rgba(88,166,255,0.15); color: var(--accent); }

  /* Summary blocks */
  .summary-block { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 12px; }
  .summary-block h3 { font-size: 13px; color: var(--text-bright); margin-bottom: 8px; }
  .summary-block .row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 12px; }
  .summary-block .row .label { color: var(--text-dim); }
  .summary-block .row .value { color: var(--text-bright); font-weight: 500; }

  /* Empty/loading */
  .empty { text-align: center; padding: 40px 20px; color: var(--text-dim); }
  .loading { text-align: center; padding: 30px; color: var(--text-dim); }
  @keyframes pulse { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
  .loading span { animation: pulse 1.5s infinite; }

  /* Evidence block */
  .evidence { background: rgba(63,185,80,0.08); border: 1px solid rgba(63,185,80,0.3); border-radius: 8px; padding: 14px 16px; margin-bottom: 16px; }
  .evidence h3 { font-size: 13px; color: var(--green); margin-bottom: 8px; }
  .evidence p { font-size: 12px; color: var(--text); line-height: 1.5; }
  .evidence code { background: var(--surface); padding: 2px 5px; border-radius: 3px; font-size: 11px; }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>IANAE</h1>
    <span class="subtitle">Sistema de Inteligencia Emergente</span>
    <div class="tabs" style="margin-left:auto">
      <button class="active" onclick="setTab('hilos')">Hilos</button>
      <button onclick="setTab('timeline')">Timeline</button>
      <button onclick="setTab('costes')">Costes LLM</button>
      <button onclick="setTab('codigo')">Codigo Real</button>
    </div>
  </header>

  <div class="dashboard" id="dashboard">
    <div class="card accent"><div class="card-label">Total Docs</div><div class="card-value" id="d-docs">-</div></div>
    <div class="card green"><div class="card-label">Completados</div><div class="card-value" id="d-ok">-</div></div>
    <div class="card red"><div class="card-label">Fallidos</div><div class="card-value" id="d-fail">-</div></div>
    <div class="card orange"><div class="card-label">Coste Total LLM</div><div class="card-value" id="d-cost">-</div><div class="card-sub" id="d-cost-sub"></div></div>
    <div class="card purple"><div class="card-label">Llamadas LLM</div><div class="card-value" id="d-calls">-</div><div class="card-sub" id="d-calls-sub"></div></div>
    <div class="card"><div class="card-label">Tasa Exito</div><div class="card-value" id="d-rate">-</div></div>
  </div>

  <nav class="sidebar">
    <h3>Vista</h3>
    <button class="nav-btn active" onclick="filterWorker('all')" data-w="all">
      <span class="icon" style="background:var(--text-dim)"></span>Todos<span class="badge" id="b-all">0</span>
    </button>
    <h3>Workers</h3>
    <button class="nav-btn" onclick="filterWorker('worker-core')" data-w="worker-core">
      <span class="icon" style="background:var(--green)"></span>worker-core<span class="badge" id="b-worker-core">0</span>
    </button>
    <button class="nav-btn" onclick="filterWorker('worker-nlp')" data-w="worker-nlp">
      <span class="icon" style="background:var(--accent)"></span>worker-nlp<span class="badge" id="b-worker-nlp">0</span>
    </button>
    <button class="nav-btn" onclick="filterWorker('worker-infra')" data-w="worker-infra">
      <span class="icon" style="background:var(--orange)"></span>worker-infra<span class="badge" id="b-worker-infra">0</span>
    </button>
    <button class="nav-btn" onclick="filterWorker('worker-ui')" data-w="worker-ui">
      <span class="icon" style="background:var(--pink)"></span>worker-ui<span class="badge" id="b-worker-ui">0</span>
    </button>
    <h3>Tipo</h3>
    <button class="nav-btn" onclick="filterWorker('especificaciones')" data-w="especificaciones">
      <span class="icon" style="background:var(--purple)"></span>Ordenes<span class="badge" id="b-especificaciones">0</span>
    </button>
    <button class="nav-btn" onclick="filterWorker('reportes')" data-w="reportes">
      <span class="icon" style="background:var(--green)"></span>Reportes<span class="badge" id="b-reportes">0</span>
    </button>
    <button class="nav-btn" onclick="filterWorker('completados')" data-w="completados">
      <span class="icon" style="background:var(--green)"></span>Completados<span class="badge" id="b-completados">0</span>
    </button>
    <button class="nav-btn" onclick="filterWorker('fallos')" data-w="fallos">
      <span class="icon" style="background:var(--red)"></span>Fallos<span class="badge" id="b-fallos">0</span>
    </button>
  </nav>

  <main class="main" id="main">
    <div class="loading"><span>Cargando...</span></div>
  </main>
</div>

<script>
const API = window.location.origin;
let allDocs = [];
let costData = null;
let codeData = null;
let currentWorker = 'all';
let currentTab = 'hilos';
let autoRefresh = true;
let refreshTimer = null;

// ===== Fetch =====
async function fetchAll() {
  await Promise.all([fetchDocs(), fetchCosts(), fetchCode(), fetchStats()]);
}

async function fetchDocs() {
  try {
    const r = await fetch(`${API}/api/v1/docs?limit=500`);
    const d = await r.json();
    allDocs = (d.docs || []).sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
    updateBadges();
    render();
  } catch(e) {
    document.getElementById('main').innerHTML = `<div class="empty"><h3>Error: ${e.message}</h3></div>`;
  }
}

async function fetchCosts() {
  try {
    const r = await fetch(`${API}/api/v1/metrics/costs`);
    costData = await r.json();
    updateDashboardCosts();
  } catch(e) { costData = null; }
}

async function fetchCode() {
  try {
    const r = await fetch(`${API}/api/v1/metrics/code`);
    codeData = await r.json();
  } catch(e) { codeData = null; }
}

async function fetchStats() {
  try {
    const r = await fetch(`${API}/api/v1/metrics/system`);
    const d = await r.json();
    const q = d.quality || {};
    document.getElementById('d-docs').textContent = d.total_documentos || 0;
    document.getElementById('d-ok').textContent = q.total_completados || 0;
    document.getElementById('d-fail').textContent = q.total_bloqueados || 0;
  } catch(e) {}
}

function updateDashboardCosts() {
  if (!costData) return;
  const el = (id) => document.getElementById(id);
  el('d-cost').textContent = '$' + costData.total_cost_usd.toFixed(4);
  el('d-cost-sub').textContent = `${fmtTokens(costData.total_input_tokens)} in / ${fmtTokens(costData.total_output_tokens)} out`;
  el('d-calls').textContent = costData.total_calls;
  el('d-calls-sub').textContent = Object.entries(costData.by_provider || {}).map(([k,v]) => `${k}: ${v.calls}`).join(', ');
  el('d-rate').textContent = costData.success_rate + '%';
  // Color the rate
  const rateEl = el('d-rate');
  if (costData.success_rate >= 50) rateEl.style.color = 'var(--green)';
  else if (costData.success_rate >= 20) rateEl.style.color = 'var(--orange)';
  else rateEl.style.color = 'var(--red)';
}

function fmtTokens(n) {
  if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return n;
}

function updateBadges() {
  const set = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
  set('b-all', allDocs.length);
  ['worker-core','worker-nlp','worker-infra','worker-ui'].forEach(w => {
    set('b-'+w, allDocs.filter(d => hasTags(d,w) || d.author===w).length);
  });
  set('b-especificaciones', allDocs.filter(d => d.category==='especificaciones').length);
  set('b-reportes', allDocs.filter(d => d.category==='reportes').length);
  set('b-completados', allDocs.filter(d => (d.title||'').includes('COMPLETADO')).length);
  set('b-fallos', allDocs.filter(d => (d.title||'').includes('FALLO')).length);
}

// ===== Helpers =====
function hasTags(doc, t) {
  const tags = typeof doc.tags === 'string' ? doc.tags : JSON.stringify(doc.tags||[]);
  return tags.toLowerCase().includes(t.toLowerCase());
}
function parseTags(doc) { try { return typeof doc.tags==='string' ? JSON.parse(doc.tags) : doc.tags||[]; } catch{ return []; } }
function getAv(a) { if(a==='arquitecto-daemon') return 'daemon'; if(a&&a.startsWith('worker-')) return a; return 'daemon'; }
function avLbl(a) { const m={'arquitecto-daemon':'AD','worker-core':'WC','worker-nlp':'WN','worker-infra':'WI','worker-ui':'WU'}; return m[a]||'?'; }
function timeAgo(s) { if(!s) return ''; const d=Math.floor((Date.now()-new Date(s))/1000); if(d<60) return d+'s'; if(d<3600) return Math.floor(d/60)+'m'; if(d<86400) return Math.floor(d/3600)+'h'; return Math.floor(d/86400)+'d'; }
function shortTime(s) { if(!s) return ''; return new Date(s).toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'}); }
function esc(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

function filterDocs() {
  if (currentWorker==='all') return allDocs;
  if (currentWorker==='especificaciones'||currentWorker==='reportes') return allDocs.filter(d=>d.category===currentWorker);
  if (currentWorker==='completados') return allDocs.filter(d=>(d.title||'').includes('COMPLETADO'));
  if (currentWorker==='fallos') return allDocs.filter(d=>(d.title||'').includes('FALLO'));
  return allDocs.filter(d => hasTags(d,currentWorker) || d.author===currentWorker);
}

// ===== Render =====
function render() {
  const main = document.getElementById('main');
  if (currentTab==='hilos') renderThreads(main);
  else if (currentTab==='timeline') renderTimeline(main);
  else if (currentTab==='costes') renderCosts(main);
  else if (currentTab==='codigo') renderCode(main);
}

// --- Threads ---
function buildThreads(docs) {
  const threads = new Map();
  const orphans = [];
  docs.forEach(doc => {
    const title = doc.title||'';
    let key = null;
    const m1 = title.match(/(?:Orden|ORDEN)[- ](?:CORE-)?#?(\d+)/i) || title.match(/#(\d+)/);
    if (m1) key = 'o-'+m1[1];
    const m2 = title.match(/Reporte.*(?:Orden|ORDEN)[- ]#?(\d+)/i);
    if (m2) key = 'o-'+m2[1];
    if (!key && title.match(/FASE\s+([A-Z])/i)) key = 'f-'+title.match(/FASE\s+([A-Z])/i)[1];
    if (!key && hasTags(doc,'genesis')) key = 'genesis';
    if (key) {
      if (!threads.has(key)) threads.set(key, {key, docs:[], title:''});
      threads.get(key).docs.push(doc);
    } else orphans.push(doc);
  });
  threads.forEach(t => {
    t.docs.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
    const spec = t.docs.find(d=>d.category==='especificaciones');
    t.title = (spec||t.docs[0]).title;
    t.lastActivity = t.docs[t.docs.length-1].created_at;
    t.status = t.docs[t.docs.length-1].workflow_status || t.docs[t.docs.length-1].status;
    // Check if any doc is COMPLETADO
    t.hasSuccess = t.docs.some(d => (d.title||'').includes('COMPLETADO'));
    t.hasFailure = t.docs.some(d => (d.title||'').includes('FALLO'));
  });
  const sorted = [...threads.values()].sort((a,b) => new Date(b.lastActivity)-new Date(a.lastActivity));
  orphans.forEach(d => sorted.push({key:'d-'+d.id, title:d.title, docs:[d], lastActivity:d.created_at, status:d.workflow_status||d.status, hasSuccess:false, hasFailure:false}));
  return sorted;
}

function renderThreads(container) {
  const docs = filterDocs();
  if (!docs.length) { container.innerHTML='<div class="empty"><h3>Sin documentos</h3></div>'; return; }
  const threads = buildThreads(docs);
  let h = `<div class="toolbar"><h2>${currentWorker==='all'?'Todos los hilos':currentWorker}</h2>
    <span class="info">${threads.length} hilos, ${docs.length} msgs</span>
    <div class="auto-ref"><input type="checkbox" id="ar" ${autoRefresh?'checked':''} onchange="toggleAR()"><label for="ar">Auto 10s</label></div></div>`;

  threads.forEach(t => {
    const sc = t.status||'pending';
    const icon = t.hasSuccess ? '<span style="color:var(--green);margin-right:4px">&#10003;</span>' : t.hasFailure ? '<span style="color:var(--red);margin-right:4px">&#10007;</span>' : '';
    h += `<div class="thread" id="t-${t.key}">
      <div class="thread-hdr" onclick="togThread('${t.key}')">
        ${icon}<span class="st ${sc}">${sc}</span>
        <span class="t-title">${esc(t.title)}</span>
        <span class="t-meta">${timeAgo(t.lastActivity)}</span>
        <span class="t-count">${t.docs.length}</span>
      </div><div class="thread-msgs">`;
    t.docs.forEach(d => { h += renderMsg(d); });
    h += '</div></div>';
  });
  container.innerHTML = h;
}

function renderMsg(doc) {
  const av = getAv(doc.author);
  const sc = doc.workflow_status||doc.status||'pending';
  const tags = parseTags(doc);
  const content = (doc.content||'').substring(0,400);
  const isFull = (doc.content||'').length <= 400;

  // Extract cost from content
  let costInfo = '';
  const cm = (doc.content||'').match(/<!-- COST_DATA: ({.*?}) -->/);
  if (cm) {
    try {
      const cd = JSON.parse(cm[1]);
      if (cd.provider !== 'none' && cd.cost_usd > 0)
        costInfo = `<div class="msg-cost">${cd.provider} | ${cd.input_tokens}in/${cd.output_tokens}out | $${cd.cost_usd.toFixed(4)}</div>`;
    } catch(e){}
  }
  // Legacy format
  if (!costInfo) {
    const lm = (doc.content||'').match(/## Provider\s*\n\s*(\w+)\s*\((\d+)in\/(\d+)out\)/);
    if (lm) costInfo = `<div class="msg-cost">${lm[1]} | ${lm[2]}in/${lm[3]}out</div>`;
  }

  return `<div class="msg">
    <div class="msg-av ${av}">${avLbl(doc.author)}</div>
    <div class="msg-body">
      <div class="msg-top">
        <span class="msg-author">${doc.author||'?'}</span>
        <span class="st ${sc}">${sc}</span>
        <span class="msg-time">#${doc.id} ${shortTime(doc.created_at)} ${timeAgo(doc.created_at)}</span>
      </div>
      <div class="msg-title">${esc(doc.title||'')}</div>
      <div class="msg-content" id="c-${doc.id}">${esc(content)}${isFull?'':'...'}</div>
      ${isFull?'':`<button class="msg-expand" onclick="togContent(${doc.id})">ver mas</button>`}
      ${costInfo}
      <div class="msg-tags">${tags.map(t=>`<span class="msg-tag">${esc(t)}</span>`).join('')}</div>
    </div>
  </div>`;
}

// --- Timeline ---
function renderTimeline(container) {
  const docs = filterDocs();
  if (!docs.length) { container.innerHTML='<div class="empty"><h3>Sin documentos</h3></div>'; return; }
  const sorted = [...docs].sort((a,b) => new Date(b.created_at)-new Date(a.created_at));
  let h = `<div class="toolbar"><h2>Timeline</h2><span class="info">${sorted.length} msgs</span>
    <div class="auto-ref"><input type="checkbox" id="ar" ${autoRefresh?'checked':''} onchange="toggleAR()"><label for="ar">Auto 10s</label></div></div>`;
  sorted.forEach(d => {
    const av = getAv(d.author);
    const sc = d.workflow_status||d.status||'pending';
    const isOk = (d.title||'').includes('COMPLETADO');
    const isFail = (d.title||'').includes('FALLO');
    const dotColor = isOk ? 'var(--green)' : isFail ? 'var(--red)' : av==='daemon'?'var(--purple)':av==='worker-core'?'var(--green)':'var(--accent)';
    h += `<div class="tl-msg">
      <span class="tl-time">${shortTime(d.created_at)}</span>
      <span class="tl-dot" style="background:${dotColor}"></span>
      <div class="tl-body">
        <div class="tl-title"><span class="st ${sc}" style="margin-right:4px">${sc}</span>${esc(d.title||'Sin titulo')}</div>
        <span class="tl-sub">${d.author||'?'} #${d.id} ${timeAgo(d.created_at)}</span>
      </div>
    </div>`;
  });
  container.innerHTML = h;
}

// --- Costs ---
function renderCosts(container) {
  if (!costData || !costData.calls.length) {
    container.innerHTML = '<div class="empty"><h3>Sin datos de costes LLM</h3><p>Los costes apareceran cuando el executor procese ordenes con el nuevo formato.</p></div>';
    return;
  }

  let h = '<div class="toolbar"><h2>Costes LLM</h2></div>';

  // Summary blocks
  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
  // Provider breakdown
  h += '<div class="summary-block"><h3>Por Provider</h3>';
  Object.entries(costData.by_provider).forEach(([prov, data]) => {
    h += `<div class="row"><span class="label"><span class="prov ${prov}">${prov}</span></span><span class="value">$${data.cost_usd.toFixed(4)} (${data.calls} calls)</span></div>`;
  });
  h += '</div>';

  // Rates reference
  h += '<div class="summary-block"><h3>Tarifas (por 1M tokens)</h3>';
  Object.entries(costData.rates_per_1m||{}).forEach(([prov, rates]) => {
    h += `<div class="row"><span class="label">${prov}</span><span class="value">$${rates.input} in / $${rates.output} out</span></div>`;
  });
  h += '</div></div>';

  // Calls table
  h += `<table class="cost-table"><thead><tr>
    <th>#</th><th>Orden</th><th>Provider</th><th>Tokens In</th><th>Tokens Out</th><th>Coste</th><th>Estado</th><th>Archivos</th>
  </tr></thead><tbody>`;

  costData.calls.forEach(c => {
    const sc = c.success ? 'success-cell' : 'fail-cell';
    const stLabel = c.success ? 'OK' : 'FALLO';
    h += `<tr>
      <td>${c.doc_id}</td>
      <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.order_title)}</td>
      <td><span class="prov ${c.provider}">${c.provider}</span></td>
      <td>${fmtTokens(c.input_tokens)}</td>
      <td>${fmtTokens(c.output_tokens)}</td>
      <td class="cost-val">$${c.cost_usd.toFixed(4)}</td>
      <td class="${sc}">${stLabel}</td>
      <td>${c.files.join(', ')||'-'}</td>
    </tr>`;
  });
  h += '</tbody></table>';
  container.innerHTML = h;
}

// --- Code ---
function renderCode(container) {
  let h = '<div class="toolbar"><h2>Codigo Generado</h2></div>';

  // Real evidence block
  h += `<div class="evidence">
    <h3>Codigo Real en Produccion</h3>
    <p>Estos metodos fueron implementados y estan en el codebase con <strong>100 tests pasando</strong>:</p>
    <p style="margin-top:8px">
      <code>src/core/nucleo.py</code> - 3 metodos genesis: <code>genesis_concepto()</code>, <code>detectar_candidatos_genesis()</code>, <code>ciclo_genesis()</code><br>
      <code>src/core/emergente.py</code> - 3 metodos pensamiento recursivo: <code>pensar_recursivo()</code>, <code>_evaluar_coherencia_activacion()</code>, <code>_refinar_activacion()</code><br>
      <code>src/core/pensamiento_simbolico.py</code> - Generado por DeepSeek: <code>ThoughtNode</code>, <code>ThoughtTree</code> (428 lineas)<br>
      <code>tests/core/test_genesis.py</code> - 13 tests genesis<br>
      <code>tests/core/test_emergente.py</code> - 11 tests pensamiento recursivo
    </p>
  </div>`;

  if (codeData) {
    // Successful orders
    if (codeData.successful_orders && codeData.successful_orders.length) {
      h += '<div class="summary-block"><h3 style="color:var(--green)">Ordenes Completadas con Codigo</h3>';
      codeData.successful_orders.forEach(o => {
        h += `<div class="file-card success">
          <div class="file-path">${esc(o.title)}</div>
          <div class="file-meta">${o.author} | ${shortTime(o.timestamp)} | Archivos: ${o.files.join(', ')||'N/A'}</div>
        </div>`;
      });
      h += '</div>';
    }

    // Files generated
    if (codeData.files_generated && Object.keys(codeData.files_generated).length) {
      h += '<div class="summary-block"><h3>Archivos Generados por LLM</h3>';
      Object.entries(codeData.files_generated).forEach(([path, info]) => {
        h += `<div class="file-card ${info.success?'success':'failed'}">
          <div class="file-path">${esc(path)}</div>
          <div class="file-meta">Ordenes: #${info.orders.join(', #')} | ${timeAgo(info.last_modified)}</div>
        </div>`;
      });
      h += '</div>';
    }

    // Failed orders
    if (codeData.failed_orders && codeData.failed_orders.length) {
      h += `<div class="summary-block"><h3 style="color:var(--red)">Ordenes Fallidas (${codeData.total_failed})</h3>`;
      codeData.failed_orders.slice(0, 10).forEach(o => {
        h += `<div class="file-card failed">
          <div class="file-path">${esc(o.title)}</div>
          <div class="file-meta">${o.author} | ${shortTime(o.timestamp)} | Archivos intentados: ${o.files.join(', ')||'N/A'}</div>
        </div>`;
      });
      if (codeData.failed_orders.length > 10) {
        h += `<p style="font-size:11px;color:var(--text-dim);padding:8px">...y ${codeData.failed_orders.length-10} mas</p>`;
      }
      h += '</div>';
    }
  } else {
    h += '<div class="empty"><h3>Cargando datos de codigo...</h3></div>';
  }
  container.innerHTML = h;
}

// ===== Interactions =====
function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tabs button').forEach(b => {
    b.classList.toggle('active', b.textContent.toLowerCase().replace(/\s/g,'') === tab.replace(/\s/g,'')
      || (tab==='hilos' && b.textContent==='Hilos')
      || (tab==='timeline' && b.textContent==='Timeline')
      || (tab==='costes' && b.textContent==='Costes LLM')
      || (tab==='codigo' && b.textContent==='Codigo Real'));
  });
  render();
}

function filterWorker(w) {
  currentWorker = w;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.w===w));
  render();
}

function togThread(k) { const e=document.getElementById('t-'+k); if(e) e.classList.toggle('open'); }

function togContent(id) {
  const e=document.getElementById('c-'+id);
  if(e) {
    e.classList.toggle('expanded');
    if(e.classList.contains('expanded')) {
      const d=allDocs.find(x=>x.id===id);
      if(d) e.textContent=d.content||'';
    }
  }
}

function toggleAR() {
  autoRefresh = document.getElementById('ar').checked;
  if(autoRefresh) startRefresh(); else stopRefresh();
}

function startRefresh() { stopRefresh(); refreshTimer=setInterval(()=>{fetchDocs();fetchCosts();fetchCode();fetchStats();},10000); }
function stopRefresh() { if(refreshTimer){clearInterval(refreshTimer);refreshTimer=null;} }

// ===== Init =====
fetchAll();
startRefresh();
</script>
</body>
</html>
