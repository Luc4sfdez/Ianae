# === Stage 1: Builder ===
FROM python:3.11-slim AS builder

WORKDIR /build

COPY requirements.txt .
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt && \
    pip install --no-cache-dir --prefix=/install \
    pytest pytest-cov pytest-timeout pytest-asyncio pytest-xdist hypothesis

# === Stage 2: Test runner ===
FROM python:3.11-slim

WORKDIR /app

COPY --from=builder /install /usr/local

COPY src/ ./src/
COPY tests/ ./tests/
COPY pyproject.toml .

ENV PYTHONUNBUFFERED=1

CMD ["pytest", "tests/", \
     "--cov=src/core", \
     "--cov-report=term-missing", \
     "--cov-report=xml:/app/coverage.xml", \
     "-v", \
     "--timeout=60", \
     "-x"]
