version: "3.8"

services:
  ianae:
    build:
      context: .
      dockerfile: docker/Dockerfile
    volumes:
      - ianae-data:/app/data
    environment:
      - IANAE_ENV=production
      - IANAE_DATA_DIR=/app/data
    networks:
      - ianae-net
    restart: unless-stopped

  docs-service:
    build:
      context: .
      dockerfile: docker/Dockerfile.docs-service
    ports:
      - "25500:25500"
    volumes:
      - docs-data:/app/data
    environment:
      - DOCS_DB_PATH=/app/data/docs.db
    networks:
      - ianae-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:25500/api/v1/context/snapshot')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  tests:
    build:
      context: .
      dockerfile: docker/Dockerfile.tests
    profiles:
      - test
    networks:
      - ianae-net

volumes:
  ianae-data:
  docs-data:

networks:
  ianae-net:
    driver: bridge
